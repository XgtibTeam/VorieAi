<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Programming Assistant</title>
<style>
/* minimal styles; keep your previous animated design if you want */
body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:#0f1113;color:#e6eef3;margin:0}
.container{max-width:980px;margin:28px auto;background:#0b0c0d;border-radius:12px;overflow:hidden;display:grid;grid-template-columns:320px 1fr}
.sidebar{padding:18px;border-right:1px solid rgba(255,255,255,0.03)}
.main{display:flex;flex-direction:column}
.header{padding:18px;border-bottom:1px solid rgba(255,255,255,0.03)}
.messages{padding:18px;height:560px;overflow:auto;display:flex;flex-direction:column;gap:12px}
.msg{max-width:76%;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02)}
.msg.user{align-self:flex-end;background:linear-gradient(180deg,#1b1f23,#15181b)}
.controls{display:flex;gap:8px;padding:12px;border-top:1px solid rgba(255,255,255,0.03)}
textarea{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
button{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;cursor:pointer}
</style>
</head>
<body>
<div class="container">
  <div class="sidebar">
    <h3>AI Programming Assistant</h3>
    <div><small>Backend: server-side JSONBin (secured)</small></div>
    <div style="margin-top:12px">
      <button id="new">New Chat</button>
      <button id="historyBtn">Load History</button>
    </div>
  </div>
  <div class="main">
    <div class="header"><strong>Selamat malam, Vorie</strong></div>
    <div class="messages" id="messages"></div>
    <div class="controls">
      <textarea id="input" placeholder='Tulis: "example in python" atau "debug this error" atau "run:<html>.."</textarea>
      <button id="send">Send</button>
    </div>
  </div>
</div>

<script>
const messagesEl = document.getElementById('messages');
const input = document.getElementById('input');
const send = document.getElementById('send');
const newBtn = document.getElementById('new');
const historyBtn = document.getElementById('historyBtn');

let currentSession = null;

function renderMessage(role,text){
  const d = document.createElement('div');
  d.className = 'msg ' + (role==='user'?'user':'ai');
  d.innerHTML = `<div>${escapeHtml(text)}</div><div style="font-size:11px;color:#9aa3ac;margin-top:6px">${new Date().toLocaleString()}</div>`;
  messagesEl.appendChild(d);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function escapeHtml(s){ return s.replaceAll('<','&lt;').replaceAll('>','&gt;'); }

async function sendMessage(){
  const text = input.value.trim(); if(!text) return;
  renderMessage('user', text);
  input.value = '';
  try{
    const res = await fetch('/chat', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ sessionId: currentSession, message: text }) });
    const j = await res.json();
    if(j && j.ai && j.ai.text) {
      currentSession = j.sessionId;
      renderMessage('ai', j.ai.text);
    } else if (j && j.reply) {
      renderMessage('ai', j.reply);
    } else {
      renderMessage('ai', 'No reply from server');
    }
  }catch(e){
    renderMessage('ai', 'Error: ' + e.message);
  }
}

send.addEventListener('click', sendMessage);
input.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }});
newBtn.addEventListener('click', ()=>{ messagesEl.innerHTML=''; currentSession = null; renderMessage('ai','New chat started'); });
historyBtn.addEventListener('click', async ()=> {
  const res = await fetch('/history');
  const j = await res.json();
  if(j && j.history){
    messagesEl.innerHTML='';
    j.history.slice(-200).forEach(m => renderMessage(m.role, m.text));
  } else alert('No history');
});
</script>
</body>
      </html>
        
